<!DOCTYPE html>
<html>
    <head>
        <title>pkworlde</title>
    </head>

    <body>
        <h1>Parkour Wordle</h1>
        <h3>Instructions</h3>
        <p>You have 6 attempts to guess a 5-letter word that is related to parkour.</p>
        <p><span style="font-weight:bold; color: green">Green</span> letters mean the letter is in the right place. <span style="font-weight:bold; color: gold">Yellow</span> letters mean the letter is in the wrong place. <span style="font-weight:bold; color: gray">Gray</span> letters mean the word doesn't contain (any more of) those letters.</p>
    </body>
    
    <main>
        <table id="table">
            <th colspan="5">
                Wordle
            </th>
            <tr>
                <td>_</td>
                <td>_</td>
                <td>_</td>
                <td>_</td>
                <td>_</td>
            </tr>
            <tr>
                <td>_</td>
                <td>_</td>
                <td>_</td>
                <td>_</td>
                <td>_</td>
            </tr>
            <tr>
                <td>_</td>
                <td>_</td>
                <td>_</td>
                <td>_</td>
                <td>_</td>
            </tr>
            <tr>
                <td>_</td>
                <td>_</td>
                <td>_</td>
                <td>_</td>
                <td>_</td>
            </tr>
            <tr>
                <td>_</td>
                <td>_</td>
                <td>_</td>
                <td>_</td>
                <td>_</td>
            </tr>
            <tr>
                <td>_</td>
                <td>_</td>
                <td>_</td>
                <td>_</td>
                <td>_</td>
            </tr>
        </table>

        <form method="get" onsubmit="handleSubmit(event)">
            <input id="input-field" type="text" pattern="[a-zA-Z]+" minlength="5" maxlength="5" placeholder="Your word" required>
            <input id="submit" type="submit" name="submit" value="Enter">
        </form>
        
        <div id="keyboard" style="margin-top:20px;">
            <div>
                <button type="button" class="key" onclick="pressKey('Q')">Q</button>
                <button type="button" class="key" onclick="pressKey('W')">W</button>
                <button type="button" class="key" onclick="pressKey('E')">E</button>
                <button type="button" class="key" onclick="pressKey('R')">R</button>
                <button type="button" class="key" onclick="pressKey('T')">T</button>
                <button type="button" class="key" onclick="pressKey('Y')">Y</button>
                <button type="button" class="key" onclick="pressKey('U')">U</button>
                <button type="button" class="key" onclick="pressKey('I')">I</button>
                <button type="button" class="key" onclick="pressKey('O')">O</button>
                <button type="button" class="key" onclick="pressKey('P')">P</button>
            </div>
            <div>
                <button type="button" class="key" onclick="pressKey('A')">A</button>
                <button type="button" class="key" onclick="pressKey('S')">S</button>
                <button type="button" class="key" onclick="pressKey('D')">D</button>
                <button type="button" class="key" onclick="pressKey('F')">F</button>
                <button type="button" class="key" onclick="pressKey('G')">G</button>
                <button type="button" class="key" onclick="pressKey('H')">H</button>
                <button type="button" class="key" onclick="pressKey('J')">J</button>
                <button type="button" class="key" onclick="pressKey('K')">K</button>
                <button type="button" class="key" onclick="pressKey('L')">L</button>
            </div>
            <div>
                <button type="button" class="key" onclick="pressKey('Backspace')">‚å´</button>
                <button type="button" class="key" onclick="pressKey('Z')">Z</button>
                <button type="button" class="key" onclick="pressKey('X')">X</button>
                <button type="button" class="key" onclick="pressKey('C')">C</button>
                <button type="button" class="key" onclick="pressKey('V')">V</button>
                <button type="button" class="key" onclick="pressKey('B')">B</button>
                <button type="button" class="key" onclick="pressKey('N')">N</button>
                <button type="button" class="key" onclick="pressKey('M')">M</button>
                <button type="button" class="key" onclick="pressKey('Enter')">‚èé</button>
            </div>
        </div>
        <script>
        function pressKey(key) {
            const input = document.getElementById('input-field');
            if (input.disabled) return;
            if (key === 'Backspace') {
                input.value = input.value.slice(0, -1);
            } else if (key === 'Enter') {
                document.querySelector('form').requestSubmit();
            } else if (input.value.length < 5 && /^[A-Z]$/.test(key)) {
                input.value += key.toLowerCase();
            }
            input.focus();
        }
        </script>
        <style>
        #keyboard .key {
            width: 36px;
            height: 40px;
            margin: 2px;
            font-size: 1.1em;
            border-radius: 4px;
            border: 1px solid #bbb;
            background: #eee;
            cursor: pointer;
            user-select: none;
        }
        #keyboard {
            display: inline-block;
            text-align: center;
        }
        #keyboard div {
            margin-bottom: 4px;
        }
        </style>
    
        <div id="result"></div>
        <div id="count"></div>
        <div id="extra"></div>
        <div id="time until next word"></div>

        <div id="share-display">
            <button id="share" onclick="shareToClipboard()" disabled>Share</button>
            <p id="clipboard"></p>            
        </div>

        <script>
let guessHistory = {};
let gameState = "active";
let guessCount = 0;
let solution = "angle";
let validWords;

function readTextFile() {
    return new Promise((resolve, reject) => {
        let xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function () {
            if (xhr.readyState === 4) {
                if (xhr.status === 200) {
                    validWords = xhr.responseText;
                    resolve(validWords);
                } else {
                    reject(new Error(`Failed to load the file. Status: ${xhr.status}`));
                }
            }
        };

        xhr.open('GET', '5 letter words.txt', true);
        xhr.send();
    });
}

readTextFile()
.then((value) => {
        console.log(`Loaded dictionary`);
        console.log(`The solution has been decided`);
        return Promise.resolve();
    })
    .catch((error) => {
        console.error(error);
    });

let words = [
  '0x58541283804c', '0x5a24cd629f6b', '0x5dc81f9b3e54',
  '0x960b15c1feb',  '0xa781dac7e73',  '0x68b076d38b8c',
  '0x585235332a05', '0xa46503c0c7b',  '0x68b19fe53e2c',
  '0xa8f4da2aa2b',  '0x593cabbbb42c', '0xe8c375f0a0',
  '0x9498ca8666d',  '0x94963bd16c3',  '0x8ec41ea9e83',
  '0xae94bd7f1fa',  '0x917a2047dbb',  '0x5f98dae5217c',
  '0x593b45ed316c', '0x68afc34bfb24', '0x68b341b98d74',
  '0xa78469df454',  '0xe8c8abd149',   '0x90377a8d4d6',
  '0x10c024c6be3',  '0x5a2278be24ec', '0x90377a8e478',
  '0x6b6a7d223c7b', '0x68b128ecde25', '0x5a241a923d74',
  '0xa0076d76418',  '0x65f581dc72f4', '0xa78469de0da',
  '0xa323d8a4bc5',  '0x1105d6693c5',  '0x8ec58eb3ed3',
  '0x91aa91aabe1',  '0xa3226914ca0',  '0x6998d34efb03',
  '0x699aecb4063a', '0x585236180014', '0x98c0c84c893',
  '0xa320eaf4b71',  '0x68b0b1b73e6d', '0x593a92c13a33',
  '0x65f493253661', '0x977d019a653',  '0xe6c359a91d',
  '0x9493a0b90dd',  '0xa7841839a9c',  '0x60835097dd33',
  '0x616d13f45c80', '0x9ec52626d7f',  '0x6423d89252fb',
  '0x6422e9f98f33', '0x94975ac755d',  '0x5eb041bc1881',
  '0x8ec1d505d63',  '0xa74e129f3eb',  '0x68af1123b078',
  '0x1001122b17f',  '0x67c63c6f1fbc'
]
let today = new Date();
let utcDate = new Date(Date.UTC(today.getUTCFullYear(), today.getUTCMonth(), today.getUTCDate()));
let nextMidnight = new Date(Date.UTC(today.getUTCFullYear(), today.getUTCMonth(), today.getUTCDate() + 1));
let seed = utcDate.getTime() / 86400000;
function seededRandom(seed) {
        // Mulberry32 PRNG
        var t = seed += 0x6D2B79F5;
        t = Math.imul(t ^ t >>> 15, t | 1);
        t ^= t + Math.imul(t ^ t >>> 7, t | 61);
        return ((t ^ t >>> 14) >>> 0) / 4294967296;
    };
let randIndex = Math.floor(seededRandom(seed) * words.length);

function toChar(str) {
    code = "";
    finalResult = "";
    for (char of str) {
        code += char;
        if (96 < Number(code) && Number(code) < 123) {
            finalResult += String.fromCharCode(code);
            code = "";
        }
    }
    return finalResult
}

// Update keyboard colors
function updateKeyboardColors(guessHistory, guessCount) {
    const keyButtons = document.querySelectorAll('.key');
    // Track best color for each letter
    const keyColors = {};
    for (let i = 1; i <= guessCount; i++) {
        for (let j = 0; j < 5; j++) {
            const emoji = guessHistory[i][j];
            const letter = table.rows[i].cells[j].textContent.toUpperCase();
            if (!/^[A-Z]$/.test(letter)) continue;
            if (emoji === "üü©") {
                keyColors[letter] = "green";
            } else if (emoji === "üü®" && keyColors[letter] !== "green") {
                keyColors[letter] = "gold";
            } else if (emoji === "‚¨õ" && !keyColors[letter]) {
                keyColors[letter] = "gray";
            }
        }
    }
    keyButtons.forEach(btn => {
        const letter = btn.textContent.trim().toUpperCase();
        if (keyColors[letter]) {
            btn.style.background = keyColors[letter];
            btn.style.color = (keyColors[letter] === "gray") ? "#fff" : "#000";
        } else {
            btn.style.background = "#eee";
            btn.style.color = "#000";
        }
    });
}


function handleSubmit(event) {
    event.preventDefault()
    
    // solution
    // Set random seed based on UTC date and pick from words
    
    let trueSol = toChar(parseInt(words[randIndex]).toString());

    // get elements
    var inputField = document.getElementById('input-field');
    var displayDiv = document.getElementById('result');

    var inputData = inputField.value.toLowerCase();

    // validation
    if (!/[a-zA-Z]+/.test(inputData) || inputData.length != 5) {
        displayDiv.innerHTML = `<span style='color:red'>There seems to be an error, try again</span>`;
        return;
    }
    if (!validWords.includes(inputData)) {
        displayDiv.innerHTML = `<span style='color:red'>${inputData} is not a valid word</span>`;
        return;
    }

    // reset input field
    inputField.value = "";

    let charPos = {};
    for (let i = 0; i < trueSol.length; i++) {
        charPos[i] = inputData[i];
    }

    let charCount = {};
    for (let char of trueSol) {
        charCount[char] = (charCount[char] || 0) + 1;
    }

    guessCount++;
    guessHistory[guessCount] = {0:"", 1:"", 2:"", 3:"", 4:"", 5:""};

    var displayCount = document.getElementById('count');
    if (guessCount === 1) {
        displayCount.textContent = `You guessed ${guessCount} time`
    } else {
        displayCount.textContent = `You guessed ${guessCount} times`
    }

    // display the input
    displayDiv.textContent = `You typed ${inputData}`;
    
    let table = document.getElementById("table");    
    // The Main Calculations
    // green letters
    for (let i = 0; i < trueSol.length; i++) {
        if (trueSol[i] === inputData[i]) {
            table.rows[guessCount].cells[i].innerHTML = `<span style="color:green">${inputData[i]}</span>`;
            charCount[inputData[i]]--;
            guessHistory[guessCount][i] = "üü©";
            delete charPos[i];
        }
    
    }
    

    // win
    if (inputData === trueSol) {
        gameState = "win"
        result();
        updateKeyboardColors(guessHistory, guessCount);
        return
    }

    // yellow and gray letters
    Object.entries(charPos).forEach( ([index, char]) => {
        if (trueSol.includes(char) && charCount[char] > 0) {
            table.rows[guessCount].cells[index].innerHTML = `<span style="color:gold">${char}</span>`;
            charCount[char]--;
            guessHistory[guessCount][index] = "üü®";
        } else {
            table.rows[guessCount].cells[index].innerHTML = `<span style="color:gray">${char}</span>`;
            guessHistory[guessCount][index] = "‚¨õ";
        }
    })
    updateKeyboardColors(guessHistory, guessCount);

    // lose
    if (guessCount === 6) {
        gameState = "lose";
        result();
        return
    }
}

function result() {
    document.getElementById('input-field').disabled = true;
    document.getElementById('submit').disabled = true;
    document.getElementById('share').disabled = false;

    switch (gameState) {
        case "win":
            var displayCount = document.getElementById('count');
            displayCount.textContent = `Win! Took ${guessCount} guesses.`
            break;
        
        case "lose":
            var displayCount = document.getElementById('count');
            displayCount.textContent = `Lose! Word was ${toChar(parseInt(words[randIndex]).toString())}.`
            break;
    }

    // banter
    switch (guessCount) {
        case 1:
            document.getElementById("extra").textContent = "Then if a player that can cheat but cannot be proven, then he is not a cheater.";
            break;
        case 2:
            document.getElementById("extra").textContent = "Lucky much?";
            break;
        case 3:
            document.getElementById("extra").textContent = "Smooth play!";
            break;
        case 4:
            document.getElementById("extra").textContent = "Great job parkourer!"
            break;
        case 5:
            document.getElementById("extra").textContent = "Made it, maybe a little bit too close.";
            break;
        case 6:
            if (gameState === "win") {
                document.getElementById("extra").textContent = "You were this goddamn close!";
            } else {
                document.getElementById("extra").textContent = "Go back to manacube.";
            }
            break;
    }

    function updateCountdown() {
        const now = new Date();
        const diff = nextMidnight - now;
        if (diff > 0) {
            const hours = String(Math.floor(diff / 3600000)).padStart(2, '0');
            const minutes = String(Math.floor((diff % 3600000) / 60000)).padStart(2, '0');
            const seconds = String(Math.floor((diff % 60000) / 1000)).padStart(2, '0');
            document.getElementById("time until next word").textContent = `Next word in ${hours}:${minutes}:${seconds}`;
        } else {
            document.getElementById("time until next word").textContent = "New word available, refresh to play again!";
        }
    }
    updateCountdown();
    setInterval(updateCountdown, 1000);
    
}

function shareToClipboard() {
    let text = 'Parkour Wordle ';

    if (gameState === "win") {
        text += `${guessCount}/6\n`;
    } else if (gameState === "lose") {
        text += `Failed\n`;
    }

    Object.values(guessHistory).forEach( (colors) => {
        Object.values(colors).forEach((emoji) => {

            text += emoji;
        })

        text += "\n";
    })
    text += "https://anon-noob.github.io/";

    navigator.clipboard.writeText(text);
    document.getElementById("clipboard").textContent = "Copied to clipboard!";
}
        </script>


    </main>

    <br>
</html>
